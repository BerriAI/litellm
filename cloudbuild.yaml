# cloudbuild.yaml
steps:
- name: 'gcr.io/kaniko-project/executor:latest'
  args:
  # Enable Kaniko cache using a dedicated cache repository
  - '--cache=true'
  # Define the cache repository location (adjust project/repo name if needed)
  - '--cache-repo=europe-west1-docker.pkg.dev/thl-sre-d-synapse/general/litellm-cache' # Added '-cache' suffix
  # Define the primary destination image (tag provided by GitLab CI)
  - '--destination=europe-west1-docker.pkg.dev/thl-sre-d-synapse/general/${_IMAGE_NAME}:${_IMAGETAG}'
  # Also tag as 'latest' for the development environment
  - '--destination=europe-west1-docker.pkg.dev/thl-sre-d-synapse/general/${_IMAGE_NAME}:latest'
  # Specify the Dockerfile to use (root Dockerfile)
  - '--dockerfile=${_DOCKERFILE}'
  # Specify the build context (root of the repository)
  - '--context=dir://.'
  # Add any necessary build arguments here if LiteLLM requires them (none identified so far)
  # Example: - '--build-arg=SOME_ARG=some_value'

options:
  # Define disk size for the build VM
  diskSizeGb: '100'
  # Define machine type (adjust as needed, E2_HIGHCPU_8 is a starting point)
  machineType: 'E2_HIGHCPU_8'

# Default substitutions (will be overridden by GitLab CI)
substitutions:
  _IMAGE_NAME: litellm # Default image name
  _DOCKERFILE: Dockerfile # Default Dockerfile path
  _IMAGETAG: latest # Default tag
