services:
  litellm:
    build:
      context: .
      dockerfile: docker/Dockerfile.non_root
      target: runtime
      args:
        PROXY_EXTRAS_SOURCE: "local"
    depends_on:
      - squid
    # Non-root execution
    user: "101:101"
    group_add:
      - "2345"
    # Lock down privileges
    read_only: true
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true
    # Writable scratch points for runtime (tmpfs prevents host writes)
    tmpfs:
      - /.npm:rw,noexec,nosuid,nodev,size=64m,uid=101,gid=101,mode=1777
      - /nonexistent:rw,noexec,nosuid,nodev,size=64m,uid=101,gid=101,mode=700
      - /app/cache:rw,noexec,nosuid,nodev,size=128m,uid=101,gid=101,mode=1777
      - /app/migrations:rw,noexec,nosuid,nodev,size=64m,uid=101,gid=101,mode=1777
    volumes:
      - ./proxy_server_config.yaml:/app/config.yaml:ro
    environment:
      LITELLM_NON_ROOT: "true"
      NPM_CONFIG_CACHE: "/.npm"
      PRISMA_BINARY_CACHE_DIR: "/app/cache/prisma-python/binaries"
      XDG_CACHE_HOME: "/app/cache"
      LITELLM_MIGRATION_DIR: "/app/migrations"
      HTTP_PROXY: "http://squid:3128"
      HTTPS_PROXY: "http://squid:3128"
      NO_PROXY: "localhost,127.0.0.1,db"
      LITELLM_SUCCESS_CALLBACKS: prometheus
      LITELLM_CALLBACKS: prometheus
      #LITELLM_LOG: "DEBUG"
      # SERVER_ROOT_PATH: "/litellm"
    command:
      - "--port"
      - "4000"
      - "--config"
      - "/app/config.yaml"
  squid:
    image: sameersbn/squid:3.5.27-2
    restart: unless-stopped
    ports:
      - "3128:3128"
    tmpfs:
      - /var/spool/squid:rw,noexec,nosuid,nodev,size=64m
      - /var/log/squid:rw,noexec,nosuid,nodev,size=16m
