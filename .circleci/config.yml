version: 2.1
jobs:
  local_testing:
    docker:
      - image: circleci/python:3.10
    working_directory: ~/project

    steps:
      - checkout

      - run:
          name: Install Dependencies
          command: |
            python -m pip install --upgrade pip
            python -m pip install -r requirements.txt

      # Run pytest and generate JUnit XML report
      - run:
          name: Run Pytest with JUnit report
          command: |
            python -m pytest --junitxml=test-results/junit.xml

      # Store test results
      - store_test_results:
          path: test-results

  publish_to_pypi:
    docker:
      - image: cimg/python:3.8
    working_directory: ~/project

    environment:
      TWINE_USERNAME: __token__

    steps:
      - checkout

      # Check if setup.py is modified and publish to PyPI
      - run:
          name: PyPI publish
          command: |
            # if [ -n "$(git diff --name-only $CIRCLE_SHA1^..$CIRCLE_SHA1 | grep 'setup.py')" ]; then
            echo "setup.py modified"
            echo -e "[pypi]\nusername = __token__\npassword = $PYPI_API_TOKEN" > ~/.pypirc
            python -m pip install --upgrade pip
            pip install wheel
            pip install --upgrade twine setuptools
            rm -rf build dist
            echo "Building package"
            python setup.py sdist bdist_wheel
            echo "Twine upload to dist"
            echo "Contents of dist directory:"
            ls dist/
            twine upload --verbose dist/*
            # else
            #   echo "No changes to setup.py. Skipping PyPI publish."
            #   circleci step halt
            # fi

workflows:
  version: 2
  build_and_test:
    jobs:
      - local_testing

      - publish_to_pypi:
          # requires:
          #   - local_testing
          filters:
            branches:
              only:
                - main
