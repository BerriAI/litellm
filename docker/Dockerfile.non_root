# Base images
ARG LITELLM_BUILD_IMAGE=cgr.dev/chainguard/python:latest-dev
ARG LITELLM_RUNTIME_IMAGE=cgr.dev/chainguard/python:latest-dev

# -----------------
# Builder Stage
# -----------------
FROM $LITELLM_BUILD_IMAGE AS builder
WORKDIR /app

# Install build dependencies including Node.js for UI build
USER root
RUN apk add --no-cache build-base bash curl git nodejs npm \
  && pip install --no-cache-dir --upgrade pip build

# Copy project files
COPY . .

# Build Admin UI (custom enterprise UI if configured)
RUN chmod +x docker/build_admin_ui.sh && ./docker/build_admin_ui.sh

# Build standard UI if not already built by enterprise script
RUN if [ ! -d "litellm/proxy/_experimental/out" ] || [ -z "$(ls -A litellm/proxy/_experimental/out 2>/dev/null)" ]; then \
        echo "Building standard Admin UI..."; \
        cd ui/litellm-dashboard && \
        npm install && \
        npm run build && \
        mkdir -p ../../litellm/proxy/_experimental/out && \
        cp -r ./out/* ../../litellm/proxy/_experimental/out/ || echo "UI build failed, continuing without UI"; \
        cd ../..; \
    else \
        echo "UI already built (enterprise build), skipping standard build"; \
    fi

# Build package and wheel dependencies
RUN rm -rf dist/* && python -m build && \
  pip install dist/*.whl && \
  pip wheel --no-cache-dir --wheel-dir=/wheels/ -r requirements.txt

# -----------------
# Runtime Stage
# -----------------
FROM $LITELLM_RUNTIME_IMAGE AS runtime
WORKDIR /app

# Install runtime dependencies
USER root
RUN apk upgrade --no-cache && \
  apk add --no-cache bash libstdc++ ca-certificates openssl supervisor

# Copy only necessary artifacts from builder stage for runtime
COPY . .
COPY --from=builder /app/docker/entrypoint.sh /app/docker/prod_entrypoint.sh /app/docker/
COPY --from=builder /app/docker/supervisord.conf /etc/supervisord.conf
COPY --from=builder /app/schema.prisma /app/schema.prisma
COPY --from=builder /app/dist/*.whl .
COPY --from=builder /wheels/ /wheels/

# Install package from wheel and dependencies
RUN pip install *.whl /wheels/* --no-index --find-links=/wheels/ \
  && rm -f *.whl \
  && rm -rf /wheels

# Copy built UI from builder stage to dedicated non-root accessible location
# UI was built in builder stage at /app/litellm/proxy/_experimental/out
RUN mkdir -p /app/litellm_ui_build
COPY --from=builder /app/litellm/proxy/_experimental/out /app/litellm_ui_build/
RUN chmod -R 755 /app/litellm_ui_build && \
    echo "UI copied from builder. Files: $(ls /app/litellm_ui_build 2>/dev/null | wc -l)"

# Install semantic_router and aurelio-sdk using script
RUN chmod +x docker/install_auto_router.sh && ./docker/install_auto_router.sh

# Ensure correct JWT library is used (pyjwt not jwt)
RUN pip uninstall jwt -y && \
  pip uninstall PyJWT -y && \
  pip install PyJWT==2.9.0 --no-cache-dir

# --- Prisma Handling for Non-Root User ---
# Set Prisma cache directories
ENV PRISMA_BINARY_CACHE_DIR=/nonexistent
ENV NPM_CONFIG_CACHE=/.npm

# Install prisma and make entrypoints executable
RUN pip install --no-cache-dir prisma && \
  chmod +x docker/entrypoint.sh && \
  chmod +x docker/prod_entrypoint.sh

# Create directories and set permissions for non-root user
RUN mkdir -p /nonexistent /.npm /app/ui_cache /app/litellm_ui_build && \
  chown -R nobody:nogroup /app && \
  chown -R nobody:nogroup /nonexistent /.npm && \
  PRISMA_PATH=$(python -c "import os, prisma; print(os.path.dirname(prisma.__file__))") && \
  chown -R nobody:nogroup $PRISMA_PATH && \
  LITELLM_PKG_MIGRATIONS_PATH="$(python -c 'import os, litellm_proxy_extras; print(os.path.dirname(litellm_proxy_extras.__file__))' 2>/dev/null || echo '')/migrations" && \
  [ -n "$LITELLM_PKG_MIGRATIONS_PATH" ] && chown -R nobody:nogroup $LITELLM_PKG_MIGRATIONS_PATH

# --- OpenShift Compatibility: Apply Red Hat recommended pattern ---
# Get paths for directories that need write access at runtime
RUN PRISMA_PATH=$(python -c "import os, prisma; print(os.path.dirname(prisma.__file__))") && \
  LITELLM_PROXY_EXTRAS_PATH=$(python -c "import os, litellm_proxy_extras; print(os.path.dirname(litellm_proxy_extras.__file__))" 2>/dev/null || echo "") && \
  # Set group ownership to 0 (root group) for OpenShift compatibility && \
  chgrp -R 0 $PRISMA_PATH && \
  chgrp -R 0 /app/ui_cache && \
  chgrp -R 0 /app/litellm_ui_build && \
  [ -n "$LITELLM_PROXY_EXTRAS_PATH" ] && chgrp -R 0 $LITELLM_PROXY_EXTRAS_PATH || true && \
  # Mirror owner permissions to group (g=u) as recommended by Red Hat && \
  chmod -R g=u $PRISMA_PATH && \
  chmod -R g=u /app/ui_cache && \
  chmod -R g=u /app/litellm_ui_build && \
  [ -n "$LITELLM_PROXY_EXTRAS_PATH" ] && chmod -R g=u $LITELLM_PROXY_EXTRAS_PATH || true && \
  # Ensure directories are writable by group && \
  chmod -R g+w $PRISMA_PATH && \
  chmod -R g+w /app/ui_cache && \
  chmod -R g+w /app/litellm_ui_build && \
  [ -n "$LITELLM_PROXY_EXTRAS_PATH" ] && chmod -R g+w $LITELLM_PROXY_EXTRAS_PATH || true

# Switch to non-root user
USER nobody

# Set HOME for prisma generate to have a writable directory
ENV HOME=/app
# Set flag to indicate non-root mode for UI file handling
ENV LITELLM_NON_ROOT=true
RUN prisma generate
# --- End of Prisma Handling ---

EXPOSE 4000/tcp

# Set entrypoint and command
ENTRYPOINT ["/app/docker/prod_entrypoint.sh"]

# Append "--detailed_debug" to the end of CMD to view detailed debug logs
# CMD ["--port", "4000", "--detailed_debug"]
CMD ["--port", "4000"]
