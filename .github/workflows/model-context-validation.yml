name: Model Context Validation

on:
  pull_request:
    paths:
      - 'model_prices_and_context_window.json'
      - '**/model_context*.json'
      - '**/context_window*.json'

jobs:
  validate-model-context:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate JSON Structure
        run: |
          echo "üîç Validating JSON structure..."
          if [ -f "model_prices_and_context_window.json" ]; then
            python -m json.tool model_prices_and_context_window.json > /dev/null
            echo "‚úÖ model_prices_and_context_window.json is valid"
          fi
          
          # Check for other model context files
          for file in $(find . -name "*model_context*.json" -o -name "*context_window*.json" | grep -v node_modules); do
            if [ -f "$file" ]; then
              python -m json.tool "$file" > /dev/null
              echo "‚úÖ $file is valid"
            fi
          done

      - name: Check for Source Citations
        run: |
          echo "üîç Checking for source citations..."
          PR_BODY="${{ github.event.pull_request.body }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          
          # Look for common citation patterns
          if echo "$PR_BODY $PR_TITLE" | grep -qiE "(source|reference|citation|url|link|documentation|api|endpoint|https?://)"; then
            echo "‚úÖ Source citations found in PR"
            echo "Found citations in PR description or title"
          else
            echo "‚ùå No source citations found"
            echo "Please include source citations in your PR description."
            echo "Examples:"
            echo "  - Source: https://provider.com/api/pricing"
            echo "  - Reference: API documentation at https://example.com/docs"
            echo "  - Based on: https://provider.com/pricing"
            exit 1
          fi

      - name: Validate Changes
        run: |
          echo "üîç Validating changes to model context files..."
          
          # Get the list of changed files
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          MODEL_CONTEXT_FILES=$(echo "$CHANGED_FILES" | grep -E "(model_prices_and_context_window\.json|.*model_context.*\.json|.*context_window.*\.json)" || true)
          
          if [ -n "$MODEL_CONTEXT_FILES" ]; then
            echo "üìù Model context files changed:"
            echo "$MODEL_CONTEXT_FILES"
            
            # Check if changes are substantial
            for file in $MODEL_CONTEXT_FILES; do
              if [ -f "$file" ]; then
                CHANGES=$(git diff --stat HEAD~1 HEAD -- "$file" | tail -1)
                echo "üìä Changes to $file: $CHANGES"
              fi
            done
          else
            echo "‚ÑπÔ∏è  No model context files changed"
          fi

      - name: Set Status Check
        run: |
          echo "‚úÖ Model Context Validation passed"
          echo "All model context files are valid and include proper source citations"