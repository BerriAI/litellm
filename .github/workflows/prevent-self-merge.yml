name: Check CI Quality Gate

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main]

jobs:
  check-ci-status:
    runs-on: ubuntu-latest
    steps:
      - name: Check CI job status
        uses: actions/github-script@v7
        with:
          script: |
            // Get GitHub Checks (newer API - GitHub Actions, some CI tools)
            const { data: checks } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.sha,
            });
            
            // Get GitHub Statuses (older API - CircleCI, Travis, etc.)
            const { data: statuses } = await github.rest.repos.getCombinedStatusForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.payload.pull_request.head.sha,
            });
            
            console.log('=== CI Status Check ===');
            console.log(`PR: #${context.payload.pull_request.number} - ${context.payload.pull_request.title}`);
            console.log(`Total checks: ${checks.check_runs.length}`);
            console.log(`Total statuses (CircleCI, etc): ${statuses.statuses.length}`);
            
            let failedJobs = [];
            let pendingJobs = [];
            let passedJobs = [];
            
            // Check GitHub Actions checks
            checks.check_runs.forEach(check => {
              console.log(`[Check] ${check.name}: ${check.status} / ${check.conclusion}`);
              
              if (check.status === 'completed' && check.conclusion === 'failure') {
                failedJobs.push(`[Check] ${check.name}`);
              } else if (check.status !== 'completed') {
                pendingJobs.push(`[Check] ${check.name}`);
              } else if (check.status === 'completed' && check.conclusion === 'success') {
                passedJobs.push(`[Check] ${check.name}`);
              }
            });
            
            // Check CircleCI and other status checks
            statuses.statuses.forEach(status => {
              console.log(`[Status] ${status.context}: ${status.state}`);
              
              if (status.state === 'failure' || status.state === 'error') {
                failedJobs.push(`[Status] ${status.context}`);
              } else if (status.state === 'pending') {
                pendingJobs.push(`[Status] ${status.context}`);
              } else if (status.state === 'success') {
                passedJobs.push(`[Status] ${status.context}`);
              }
            });
            
            console.log('\n=== Summary ===');
            console.log(`âœ… Passed: ${passedJobs.length}`);
            console.log(`â³ Pending: ${pendingJobs.length}`);
            console.log(`âŒ Failed: ${failedJobs.length}`);
            
            if (failedJobs.length > 0) {
              core.setFailed(`âŒ Cannot merge: ${failedJobs.length} CI job(s) failing:\n${failedJobs.join('\n')}`);
              return;
            }
            
            if (pendingJobs.length > 0) {
              core.setFailed(`â³ Cannot evaluate: ${pendingJobs.length} job(s) still running. Wait for all CI jobs to complete before merging.\n\nPending jobs:\n${pendingJobs.join('\n')}`);
              return;
            }
            
            // Calculate pass/fail rates
            const totalCompleted = passedJobs.length + failedJobs.length;
            const passRate = totalCompleted > 0 ? (passedJobs.length / totalCompleted * 100).toFixed(1) : 0;
            const failRate = totalCompleted > 0 ? (failedJobs.length / totalCompleted * 100).toFixed(1) : 0;
            
            console.log(`\nğŸ“Š Pass Rate: ${passRate}%`);
            console.log(`ğŸ“Š Fail Rate: ${failRate}%`);
            
            // Block if 10% or more jobs fail
            const maxFailRate = 10;
            if (parseFloat(failRate) >= maxFailRate) {
              core.setFailed(`âŒ CI fail rate (${failRate}%) exceeds maximum threshold (${maxFailRate}%)`);
              return;
            }
            
            console.log('âœ… All CI quality checks passed!');
