"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5809],{85809:function(e,l,t){t.d(l,{Z:function(){return P}});var s=t(57437),r=t(2265),a=t(87452),n=t(88829),i=t(72208),c=t(41649),o=t(20831),d=t(12514),u=t(49804),m=t(67101),h=t(27281),x=t(57365),g=t(21626),f=t(97214),j=t(28241),y=t(58834),p=t(69552),b=t(71876),Z=t(84264),_=t(49566),k=t(96761),N=t(9335),v=t(19250),w=t(13634),S=t(20577),C=t(74998),F=t(44643),O=t(16312),A=t(54250),V=t(70450),q=t(82680),E=t(51601),R=t(9114),z=e=>{let{models:l,accessToken:t,routerSettings:a,setRouterSettings:n}=e,[i]=w.Z.useForm(),[c,o]=(0,r.useState)(!1),[d,u]=(0,r.useState)(""),[m,h]=(0,r.useState)([]),[x,g]=(0,r.useState)([]);(0,r.useEffect)(()=>{(async()=>{try{let e=await (0,E.p)(t);console.log("Fetched models for fallbacks:",e),h(e)}catch(e){console.error("Error fetching model info for fallbacks:",e)}})()},[t]);let f=()=>{o(!1),i.resetFields(),g([]),u("")};return(0,s.jsxs)("div",{children:[(0,s.jsx)(O.z,{className:"mx-auto",onClick:()=>o(!0),icon:()=>(0,s.jsx)("span",{className:"mr-1",children:"+"}),children:"Add Fallbacks"}),(0,s.jsx)(q.Z,{title:(0,s.jsx)("div",{className:"pb-4 border-b border-gray-100",children:(0,s.jsx)("h2",{className:"text-xl font-semibold text-gray-900",children:"Add Fallbacks"})}),open:c,width:900,footer:null,onOk:()=>{o(!1),i.resetFields(),g([]),u("")},onCancel:f,className:"top-8",styles:{body:{padding:"24px"},header:{padding:"24px 24px 0 24px",border:"none"}},children:(0,s.jsxs)("div",{className:"mt-6",children:[(0,s.jsx)("div",{className:"mb-6",children:(0,s.jsx)("p",{className:"text-gray-600",children:"Configure fallback models to improve reliability. When the primary model fails or is unavailable, requests will automatically route to the specified fallback models in order."})}),(0,s.jsxs)(w.Z,{form:i,onFinish:e=>{console.log(e);let{model_name:l,models:s}=e,r=[...a.fallbacks||[],{[l]:s}],c={...a,fallbacks:r};console.log(c);try{(0,v.setCallbacksCall)(t,{router_settings:c}),n(c)}catch(e){R.Z.fromBackend("Failed to update router settings: "+e)}R.Z.success("router settings updated successfully"),o(!1),i.resetFields(),g([]),u("")},layout:"vertical",className:"space-y-6",children:[(0,s.jsxs)("div",{className:"grid grid-cols-1 gap-6",children:[(0,s.jsxs)(w.Z.Item,{label:(0,s.jsxs)("span",{className:"text-sm font-medium text-gray-700",children:["Primary Model ",(0,s.jsx)("span",{className:"text-red-500",children:"*"})]}),name:"model_name",rules:[{required:!0,message:"Please select the primary model that needs fallbacks"}],className:"!mb-0",children:[(0,s.jsx)(A.Z,{placeholder:"Select the model that needs fallback protection",value:d,onValueChange:e=>{u(e);let l=x.filter(l=>l!==e);g(l),i.setFieldValue("models",l),i.setFieldValue("model_name",e)},children:Array.from(new Set(m.map(e=>e.model_group))).map((e,l)=>(0,s.jsx)(V.Z,{value:e,children:e},l))}),(0,s.jsx)("p",{className:"text-sm text-gray-500 mt-1",children:"This is the primary model that users will request"})]}),(0,s.jsx)("div",{className:"border-t border-gray-200 my-6"}),(0,s.jsxs)(w.Z.Item,{label:(0,s.jsxs)("span",{className:"text-sm font-medium text-gray-700",children:["Fallback Models (select multiple) ",(0,s.jsx)("span",{className:"text-red-500",children:"*"})]}),name:"models",rules:[{required:!0,message:"Please select at least one fallback model"}],className:"!mb-0",children:[(0,s.jsxs)("div",{className:"space-y-3",children:[x.length>0&&(0,s.jsxs)("div",{className:"border border-gray-200 rounded-lg p-3 bg-gray-50",children:[(0,s.jsx)("p",{className:"text-sm font-medium text-gray-700 mb-2",children:"Fallback Order:"}),(0,s.jsx)("div",{className:"flex flex-wrap gap-2",children:x.map((e,l)=>(0,s.jsxs)("div",{className:"flex items-center bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm",children:[(0,s.jsxs)("span",{className:"font-medium mr-2",children:[l+1,"."]}),(0,s.jsx)("span",{children:e}),(0,s.jsx)("button",{type:"button",onClick:()=>{let l=x.filter(l=>l!==e);g(l),i.setFieldValue("models",l)},className:"ml-2 text-blue-600 hover:text-blue-800",children:"\xd7"})]},e))})]}),(0,s.jsx)(A.Z,{placeholder:"Add a fallback model",value:"",onValueChange:e=>{if(e&&!x.includes(e)){let l=[...x,e];g(l),i.setFieldValue("models",l)}},children:Array.from(new Set(m.map(e=>e.model_group))).filter(e=>e!==d&&!x.includes(e)).sort().map(e=>(0,s.jsx)(V.Z,{value:e,children:e},e))})]}),(0,s.jsxs)("p",{className:"text-sm text-gray-500 mt-1",children:[(0,s.jsx)("strong",{children:"Order matters:"})," Models will be tried in the order shown above (1st, 2nd, 3rd, etc.)"]})]})]}),(0,s.jsxs)("div",{className:"flex items-center justify-end space-x-3 pt-6 border-t border-gray-100",children:[(0,s.jsx)(O.z,{variant:"secondary",onClick:f,children:"Cancel"}),(0,s.jsx)(O.z,{variant:"primary",type:"submit",children:"Add Fallbacks"})]})]})]})})]})},D=t(26433);async function I(e,l){console.log=function(){},console.log("isLocal:",!1);let t=window.location.origin,r=new D.ZP.OpenAI({apiKey:l,baseURL:t,dangerouslyAllowBrowser:!0});try{let l=await r.chat.completions.create({model:e,messages:[{role:"user",content:"Hi, this is a test message"}],mock_testing_fallbacks:!0});R.Z.success((0,s.jsxs)("span",{children:["Test model=",(0,s.jsx)("strong",{children:e}),", received model=",(0,s.jsx)("strong",{children:l.model}),". See"," ",(0,s.jsx)("a",{href:"#",onClick:()=>window.open("https://docs.litellm.ai/docs/proxy/reliability","_blank"),style:{textDecoration:"underline",color:"blue"},children:"curl"})]}))}catch(e){R.Z.fromBackend("Error occurred while generating model response. Please try again. Error: ".concat(e))}}let B={ttl:3600,lowest_latency_buffer:0},L=e=>{let{selectedStrategy:l,strategyArgs:t,paramExplanation:r}=e;return(0,s.jsxs)(a.Z,{children:[(0,s.jsx)(i.Z,{className:"text-sm font-medium text-tremor-content-strong dark:text-dark-tremor-content-strong",children:"Routing Strategy Specific Args"}),(0,s.jsx)(n.Z,{children:"latency-based-routing"==l?(0,s.jsx)(d.Z,{children:(0,s.jsxs)(g.Z,{children:[(0,s.jsx)(y.Z,{children:(0,s.jsxs)(b.Z,{children:[(0,s.jsx)(p.Z,{children:"Setting"}),(0,s.jsx)(p.Z,{children:"Value"})]})}),(0,s.jsx)(f.Z,{children:Object.entries(t).map(e=>{let[l,t]=e;return(0,s.jsxs)(b.Z,{children:[(0,s.jsxs)(j.Z,{children:[(0,s.jsx)(Z.Z,{children:l}),(0,s.jsx)("p",{style:{fontSize:"0.65rem",color:"#808080",fontStyle:"italic"},className:"mt-1",children:r[l]})]}),(0,s.jsx)(j.Z,{children:(0,s.jsx)(_.Z,{name:l,defaultValue:"object"==typeof t?JSON.stringify(t,null,2):t.toString()})})]},l)})})]})}):(0,s.jsx)(Z.Z,{children:"No specific settings"})})]})};var P=e=>{let{accessToken:l,userRole:t,userID:a,modelData:n}=e,[i,O]=(0,r.useState)({}),[A,V]=(0,r.useState)({}),[q,E]=(0,r.useState)([]),[D,P]=(0,r.useState)(!1),[T]=w.Z.useForm(),[J,M]=(0,r.useState)(null),[K,G]=(0,r.useState)(null),[U,H]=(0,r.useState)(null),W={routing_strategy_args:"(dict) Arguments to pass to the routing strategy",routing_strategy:"(string) Routing strategy to use",allowed_fails:"(int) Number of times a deployment can fail before being added to cooldown",cooldown_time:"(int) time in seconds to cooldown a deployment after failure",num_retries:"(int) Number of retries for failed requests. Defaults to 0.",timeout:"(float) Timeout for requests. Defaults to None.",retry_after:"(int) Minimum time to wait before retrying a failed request",ttl:"(int) Sliding window to look back over when calculating the average latency of a deployment. Default - 1 hour (in seconds).",lowest_latency_buffer:"(float) Shuffle between deployments within this % of the lowest latency. Default - 0 (i.e. always pick lowest latency)."};(0,r.useEffect)(()=>{l&&t&&a&&((0,v.getCallbacksCall)(l,a,t).then(e=>{console.log("callbacks",e);let l=e.router_settings;"model_group_retry_policy"in l&&delete l.model_group_retry_policy,O(l)}),(0,v.getGeneralSettingsCall)(l).then(e=>{E(e)}))},[l,t,a]);let Q=async e=>{if(!l)return;console.log("received key: ".concat(e)),console.log("routerSettings['fallbacks']: ".concat(i.fallbacks));let t=i.fallbacks.map(l=>(e in l&&delete l[e],l)).filter(e=>Object.keys(e).length>0),s={...i,fallbacks:t};try{await (0,v.setCallbacksCall)(l,{router_settings:s}),O(s),R.Z.success("Router settings updated successfully")}catch(e){R.Z.fromBackend("Failed to update router settings: "+e)}},X=(e,l)=>{E(q.map(t=>t.field_name===e?{...t,field_value:l}:t))},Y=(e,t)=>{if(!l)return;let s=q[t].field_value;if(null!=s&&void 0!=s)try{(0,v.updateConfigFieldSetting)(l,e,s);let t=q.map(l=>l.field_name===e?{...l,stored_in_db:!0}:l);E(t)}catch(e){}},$=(e,t)=>{if(l)try{(0,v.deleteConfigFieldSetting)(l,e);let t=q.map(l=>l.field_name===e?{...l,stored_in_db:null,field_value:null}:l);E(t)}catch(e){}},ee=e=>{if(!l)return;console.log("router_settings",e);let t=new Set(["allowed_fails","cooldown_time","num_retries","timeout","retry_after"]),s=new Set(["model_group_alias","retry_policy"]),r=(e,l,r)=>{if(void 0===l)return r;let a=l.trim();if("null"===a.toLowerCase())return null;if(t.has(e)){let e=Number(a);return Number.isNaN(e)?r:e}if(s.has(e)){if(""===a)return null;try{return JSON.parse(a)}catch(e){return r}}return"true"===a.toLowerCase()||"false"!==a.toLowerCase()&&a},a=Object.fromEntries(Object.entries(e).map(e=>{let[l,t]=e;if("routing_strategy_args"!==l&&"routing_strategy"!==l){let e=document.querySelector('input[name="'.concat(l,'"]')),s=r(l,null==e?void 0:e.value,t);return[l,s]}if("routing_strategy"===l)return[l,K];if("routing_strategy_args"===l&&"latency-based-routing"===K){let e={},l=document.querySelector('input[name="lowest_latency_buffer"]'),t=document.querySelector('input[name="ttl"]');return(null==l?void 0:l.value)&&(e.lowest_latency_buffer=Number(l.value)),(null==t?void 0:t.value)&&(e.ttl=Number(t.value)),console.log("setRoutingStrategyArgs: ".concat(e)),["routing_strategy_args",e]}return null}).filter(e=>null!=e));console.log("updatedVariables",a);try{(0,v.setCallbacksCall)(l,{router_settings:a})}catch(e){R.Z.fromBackend("Failed to update router settings: "+e)}R.Z.success("router settings updated successfully")};return l?(0,s.jsx)("div",{className:"w-full mx-4",children:(0,s.jsxs)(N.v0,{className:"gap-2 p-8 h-[75vh] w-full mt-2",children:[(0,s.jsxs)(N.td,{variant:"line",defaultValue:"1",children:[(0,s.jsx)(N.OK,{value:"1",children:"Loadbalancing"}),(0,s.jsx)(N.OK,{value:"2",children:"Fallbacks"}),(0,s.jsx)(N.OK,{value:"3",children:"General"})]}),(0,s.jsxs)(N.nP,{children:[(0,s.jsx)(N.x4,{children:(0,s.jsxs)(m.Z,{numItems:1,className:"gap-2 p-8 w-full mt-2",children:[(0,s.jsx)(k.Z,{children:"Router Settings"}),(0,s.jsxs)(d.Z,{children:[(0,s.jsxs)(g.Z,{children:[(0,s.jsx)(y.Z,{children:(0,s.jsxs)(b.Z,{children:[(0,s.jsx)(p.Z,{children:"Setting"}),(0,s.jsx)(p.Z,{children:"Value"})]})}),(0,s.jsx)(f.Z,{children:Object.entries(i).filter(e=>{let[l,t]=e;return"fallbacks"!=l&&"context_window_fallbacks"!=l&&"routing_strategy_args"!=l}).map(e=>{let[l,t]=e;return(0,s.jsxs)(b.Z,{children:[(0,s.jsxs)(j.Z,{children:[(0,s.jsx)(Z.Z,{children:l}),(0,s.jsx)("p",{style:{fontSize:"0.65rem",color:"#808080",fontStyle:"italic"},className:"mt-1",children:W[l]})]}),(0,s.jsx)(j.Z,{children:"routing_strategy"==l?(0,s.jsxs)(h.Z,{defaultValue:t,className:"w-full max-w-md",onValueChange:G,children:[(0,s.jsx)(x.Z,{value:"usage-based-routing",children:"usage-based-routing"}),(0,s.jsx)(x.Z,{value:"latency-based-routing",children:"latency-based-routing"}),(0,s.jsx)(x.Z,{value:"simple-shuffle",children:"simple-shuffle"})]}):(0,s.jsx)(_.Z,{name:l,defaultValue:"object"==typeof t?JSON.stringify(t,null,2):t.toString()})})]},l)})})]}),(0,s.jsx)(L,{selectedStrategy:K,strategyArgs:i&&i.routing_strategy_args&&Object.keys(i.routing_strategy_args).length>0?i.routing_strategy_args:B,paramExplanation:W})]}),(0,s.jsx)(u.Z,{children:(0,s.jsx)(o.Z,{className:"mt-2",onClick:()=>ee(i),children:"Save Changes"})})]})}),(0,s.jsxs)(N.x4,{children:[(0,s.jsxs)(g.Z,{children:[(0,s.jsx)(y.Z,{children:(0,s.jsxs)(b.Z,{children:[(0,s.jsx)(p.Z,{children:"Model Name"}),(0,s.jsx)(p.Z,{children:"Fallbacks"})]})}),(0,s.jsx)(f.Z,{children:i.fallbacks&&i.fallbacks.map((e,t)=>Object.entries(e).map(e=>{let[r,a]=e;return(0,s.jsxs)(b.Z,{children:[(0,s.jsx)(j.Z,{children:r}),(0,s.jsx)(j.Z,{children:Array.isArray(a)?a.join(", "):a}),(0,s.jsx)(j.Z,{children:(0,s.jsx)(o.Z,{onClick:()=>I(r,l),children:"Test Fallback"})}),(0,s.jsx)(j.Z,{children:(0,s.jsx)(N.JO,{icon:C.Z,size:"sm",onClick:()=>Q(r)})})]},t.toString()+r)}))})]}),(0,s.jsx)(z,{models:(null==n?void 0:n.data)?n.data.map(e=>e.model_name):[],accessToken:l,routerSettings:i,setRouterSettings:O})]}),(0,s.jsx)(N.x4,{children:(0,s.jsx)(d.Z,{children:(0,s.jsxs)(g.Z,{children:[(0,s.jsx)(y.Z,{children:(0,s.jsxs)(b.Z,{children:[(0,s.jsx)(p.Z,{children:"Setting"}),(0,s.jsx)(p.Z,{children:"Value"}),(0,s.jsx)(p.Z,{children:"Status"}),(0,s.jsx)(p.Z,{children:"Action"})]})}),(0,s.jsx)(f.Z,{children:q.filter(e=>"TypedDictionary"!==e.field_type).map((e,l)=>(0,s.jsxs)(b.Z,{children:[(0,s.jsxs)(j.Z,{children:[(0,s.jsx)(Z.Z,{children:e.field_name}),(0,s.jsx)("p",{style:{fontSize:"0.65rem",color:"#808080",fontStyle:"italic"},className:"mt-1",children:e.field_description})]}),(0,s.jsx)(j.Z,{children:"Integer"==e.field_type?(0,s.jsx)(S.Z,{step:1,value:e.field_value,onChange:l=>X(e.field_name,l)}):null}),(0,s.jsx)(j.Z,{children:!0==e.stored_in_db?(0,s.jsx)(c.Z,{icon:F.Z,className:"text-white",children:"In DB"}):!1==e.stored_in_db?(0,s.jsx)(c.Z,{className:"text-gray bg-white outline",children:"In Config"}):(0,s.jsx)(c.Z,{className:"text-gray bg-white outline",children:"Not Set"})}),(0,s.jsxs)(j.Z,{children:[(0,s.jsx)(o.Z,{onClick:()=>Y(e.field_name,l),children:"Update"}),(0,s.jsx)(N.JO,{icon:C.Z,color:"red",onClick:()=>$(e.field_name,l),children:"Reset"})]})]},l))})]})})})]})]})}):null}}}]);